import{a as $}from"./api.esm96104.js";import{u as ee,e as te,r as O,j as oe}from"./usetoast.esm96104.js";import{u as ae}from"./useconfirm.esm96104.js";import{u as se}from"./country96104.js";import{e as M,a as re,s as j,h as T}from"./helpers96104.js";import{u as P}from"./survey96104.js";import{f as ne}from"./formatData96104.js";import{ad as le,c as D,r as y,_ as Q,a as u,i as ie,o as g,b as S,f as s,q as c,y as B,t as m,h as q,j as ce,w as A,e as b}from"./_plugin-vue_export-helper96104.js";import{w as K}from"./runtime-dom.esm-bundler96104.js";import"./datetime96104.js";const ue={setup(){le(()=>{h.value=!0,n.value={first:0,rows:f.value.rows,sortField:null,sortOrder:null,filters:C.value},$.register("myfilter",(e,a)=>e===a),x()});const d=P(),r=se(),R=ae(),o=ee(),V=D(()=>d.responseSurveys),U=D(()=>r.allCountries),w=D(()=>o.getSelectedCountry),i=D(()=>d.getReportSurvey),v=te(),f=y(),F=y(!1),C=y({name:{value:"",matchMode:"contains"},active_from:{value:"",matchMode:"contains"},active_to:{value:"",matchMode:"contains"},company_name:{value:"",matchMode:"contains"},country:{value:"",matchMode:"contains"}}),k=y(),h=y(!0),n=y(),t=y(0),l=y(),p=y([{label:"My Filter",value:"myfilter"}]);function x(){h.value=!0;const e=new Map;e.set("country_id",w.value.id),e.set("active_from",C.value.active_from.value),e.set("page",n.value.page+1),e.set("per_page",n.value.rows),n.value.sortField&&(n.value.sortOrder==1?e.set("sorted_by",n.value.sortField+"_asc"):e.set("sorted_by",n.value.sortField+"_desc")),setTimeout(()=>{L(e)},Math.random()*1e3+250)}const L=async function(e){await d.fetchAllSurveys(e).then(()=>{h.value=!1}).catch(a=>{h.value=!1,M(v,a)})},N=e=>{n.value=e,x()},z=e=>{n.value=e,x()},I=()=>{n.value.page=0,n.value.filters=C.value,x()},G=(e,a)=>{a.users_counter>0?R.require({target:e.currentTarget,message:"The survey cannot be deleted because there are associated users.",icon:"pi pi-exclamation-triangle",rejectClass:"hidden",acceptClass:"hidden"}):R.require({target:e.currentTarget,message:"Are you sure you want to remove this survey?",icon:"pi pi-exclamation-triangle",accept:()=>{H(a.id)}})},H=async function(e){await d.deleteSurvey(e).then(()=>{re(v,{message:"Survey deleted correctly.",title:""}),x()}).catch(a=>{M(v,a)})},J=function(e){O.push({name:"survey-detail",params:{id:e.id}})},W=function(e){O.push({name:"survey-report",params:{id:e.id,typology:e.typology}})},X=e=>{l.value=e,l.value.typology=="open"?E():(Y(e.id),F.value=!0)},Y=async function(e){j(),d.fetchSurveyReport(e).then(()=>{T(),k.value=Z()}).catch(a=>{T(),M(v,a)})},Z=()=>{const e=[],a=[];return i.value.answers.forEach(_=>{a.push(_.percentage),e.push(_.text.text)}),{chartData:{datasets:[{data:a,backgroundColor:["#cd1867","#DB4CB3","#EABB3D","#B958D8","#a1c653","#009265"]}],labels:e},chartOptions:{maintainAspectRatio:.5,plugins:{legend:{display:!1},tooltip:{callbacks:{label:_=>`${_.formattedValue}%`}}}}}},E=async function(){j();try{const a=await oe({method:"get",url:`/surveys/${l.value.id}/download_answers`,responseType:"blob"});var e=new Blob([a.data],{type:a.headers["content-type"]});const _=document.createElement("a");_.href=window.URL.createObjectURL(e),_.download="report_survey.xlsx",_.click(),T()}catch(a){T(),M(v,a)}};return{dt:f,responseSurveys:V,filters:C,loading:h,totalRecords:t,lazyParams:n,matchModes:p,countries:U,survey_chart:k,selected_survey:l,surveyReport:i,visible:F,loadLazyData:x,onPage:N,onSort:z,onFilter:I,toggleEdit:J,toggleReport:W,confirmDeleteSurvey:G,formatDataFromSql:ne,showTemplate:X,downloadReport:E,getQuestion:function(){var a;const e=(a=l.value.country)==null?void 0:a.default_language_code;if(e)return l.value.translations[e].title.text}}}};const de={key:0},ve={class:"col-12 flex"},pe={key:0,class:"col-8 px-0 mt-3"},ye={class:"text-center font-semibold mb-2 mt-0"},me={class:"col-4 flex justify-content-end"},fe={key:1,class:"flex flex-column mt-3"},_e={class:"mb-1"};function he(d,r,R,o,V,U){const w=u("Calendar"),i=u("Column"),v=u("Badge"),f=u("Button"),F=u("DataTable"),C=u("Chart"),k=u("Dialog"),h=u("ConfirmPopup"),n=ie("tooltip");return g(),S("div",null,[s(F,{value:o.responseSurveys.surveys,lazy:!0,paginator:!0,rows:30,filters:o.filters,"onUpdate:filters":r[0]||(r[0]=t=>o.filters=t),ref:"dt",dataKey:"id",loading:o.loading,totalRecords:o.responseSurveys.total,onPage:r[1]||(r[1]=t=>o.onPage(t)),onSort:r[2]||(r[2]=t=>o.onSort(t)),onFilter:r[3]||(r[3]=t=>o.onFilter()),filterDisplay:"row",removableSort:""},{empty:c(()=>[B(" No surveys found. ")]),default:c(()=>[s(i,{field:"active_from",header:"Active from",filterMatchMode:"contains",ref:"active_from",sortable:!1,showFilterMatchModes:!1,showFilterOperator:!1,showFilterMenu:!1},{body:c(({data:t})=>[B(m(o.formatDataFromSql(t.active_from)),1)]),filter:c(({filterModel:t,filterCallback:l})=>[s(w,{inputId:"dateformat",modelValue:t.value,"onUpdate:modelValue":p=>t.value=p,dateFormat:"dd/mm/yy",onKeydown:K(p=>l(),["enter"]),manualInput:!1,placeholder:"Filter by data",onDateSelect:p=>l()},null,8,["modelValue","onUpdate:modelValue","onKeydown","onDateSelect"])]),_:1},512),s(i,{field:"active_to",header:"Active to",filterMatchMode:"contains",ref:"active_to",sortable:!1,showFilterMatchModes:!1,showFilterOperator:!1,showFilterMenu:!1},{body:c(({data:t})=>[B(m(o.formatDataFromSql(t.active_to)),1)]),filter:c(({filterModel:t,filterCallback:l})=>[s(w,{inputId:"dateformat",modelValue:t.value,"onUpdate:modelValue":p=>t.value=p,dateFormat:"dd/mm/yy",onKeydown:K(p=>l(),["enter"]),manualInput:!1,placeholder:"Filter by data",onDateSelect:p=>l()},null,8,["modelValue","onUpdate:modelValue","onKeydown","onDateSelect"])]),_:1},512),s(i,{field:"hidden_at",header:"Visible until"},{body:c(({data:t})=>[B(m(o.formatDataFromSql(t.hidden_at)),1)]),_:1}),s(i,{field:"",header:"Question"},{body:c(({data:t})=>[t.translations[t.country.default_language_code]?(g(),S("span",de,m(t.translations[t.country.default_language_code].title.text),1)):q("",!0)]),_:1}),s(i,{header:"Results",field:"total_results"}),s(i,{header:"Status",field:"status"},{body:c(({data:t})=>[s(v,{value:t.status,class:ce(["px-4 border-round-lg",t.status])},null,8,["value","class"])]),_:1}),s(i,{header:""},{body:c(({data:t})=>[A(s(f,{type:"button",onClick:l=>o.toggleEdit(t),"aria-haspopup":"true","aria-controls":"overlay_menu",class:"p-button-text p-button-rounded text-300 surface-200 mr-3",icon:"pi pi-pencil",disabled:!t.can_edit},null,8,["onClick","disabled"]),[[n,"Edit",void 0,{top:!0}]]),A(s(f,{type:"button",onClick:l=>o.confirmDeleteSurvey(l,t),"aria-haspopup":"true","aria-controls":"overlay_menu",class:"p-button-text p-button-rounded text-300 surface-200 mr-3",icon:"pi pi-trash",disabled:!t.can_delete},null,8,["onClick","disabled"]),[[n,"Delete",void 0,{top:!0}]]),A(s(f,{type:"button",onClick:l=>o.showTemplate(t),"aria-haspopup":"true","aria-controls":"overlay_menu",class:"p-button-text p-button-rounded text-300 surface-200 mr-3",icon:"pi pi-chart-bar"},null,8,["onClick"]),[[n,"Report",void 0,{top:!0}]])]),_:1})]),_:1},8,["value","filters","loading","totalRecords"]),s(k,{style:{width:"40vw"},visible:o.visible,"onUpdate:visible":r[5]||(r[5]=t=>o.visible=t),modal:"",header:"Survey report"},{default:c(()=>[b("div",ve,[o.selected_survey.typology=="closed"&&o.selected_survey.id&&o.surveyReport&&o.surveyReport.answers&&o.survey_chart?(g(),S("div",pe,[b("p",ye,m(o.getQuestion())+" - Respondents: "+m(o.surveyReport.total),1),s(C,{type:"bar",data:o.survey_chart.chartData,options:o.survey_chart.chartOptions},null,8,["data","options"])])):q("",!0),b("div",me,[s(f,{class:"p-button-outlined p-button-secondary",label:"Report",icon:"pi pi-download",onClick:r[4]||(r[4]=t=>o.downloadReport())})]),o.selected_survey.typology=="open"&&o.surveyReport?(g(),S("div",fe,[b("span",_e,"Question: "+m(o.getQuestion()),1),b("span",null,"Respondents: "+m(o.surveyReport.total||"-"),1)])):q("",!0)])]),_:1},8,["visible"]),s(h)])}const be=Q(ue,[["render",he]]),ge={setup(){const d=P();return{totalSurvey:D(()=>d.getTotalSurveys)}},components:{SurveysTable:be}},Se={class:"flex justify-content-between align-items-center"},we={class:"uppercase"},Ce={key:0},xe={key:1};function De(d,r,R,o,V,U){const w=u("Button"),i=u("SurveysTable"),v=u("Card");return g(),S("div",null,[s(v,null,{content:c(()=>[b("div",Se,[b("h1",we,[o.totalSurvey==1?(g(),S("span",Ce," 1 Survey")):(g(),S("span",xe,m(o.totalSurvey)+" Surveys",1))]),s(w,{label:"survey",onClick:r[0]||(r[0]=f=>d.$router.push("/survey-detail")),icon:"pi pi-plus",class:"mb-3"})]),s(i)]),_:1})])}const Oe=Q(ge,[["render",De]]);export{Oe as default};
