import{a as ee}from"./api.esm86487.js";import{ae as j,aq as te,ai as oe,ar as ae,ad as ne,ac as se,o as I,r as f,_ as N,e as i,f as u,g as y,C as h,E as F,j as z,F as le,D as re,u as K,c as T,af as L,z as de,a as ie,b,l as ue,h as s,B as p,w as ce,n as pe}from"./usetoast.esm86487.js";import{u as me}from"./country86487.js";import{o as M,e as U,a as R,s as O,h as A}from"./helpers86487.js";import{u as ge}from"./useconfirm.esm86487.js";import{u as _e}from"./usedialog.esm86487.js";import{w as E}from"./runtime-dom.esm-bundler86487.js";import{D as fe}from"./datetime86487.js";class V{static async fetchAll(o){return(await j("/budget_data",o)).data}static async getBudgetDetail(o){return(await j(`/budget_data/${o}`)).data.budget}static async deleteBudget(o){return(await te(`/budget_data/${o}`)).data}static async updateBudget(o){return(await oe(`/budget_data/${o.id}`,o.budget_data)).data.budget_data}static async importBudget(o){return(await ae("/budget_data/upload_budget",o.formData)).data.updated_targets}}const P=ne({id:"budget",state:()=>({current_budget:{},budget:[],response_budget:{},total_budget:Number,budget_imported:""}),getters:{allBudget:a=>a.response_budget.budget_data,responseBudget:a=>a.response_budget,getTotalBudget:a=>a.response_budget?a.response_budget.total:0,getCurrentBudget:a=>a.current_budget,budgetStatus:()=>[{name:"Online",value:"online"},{name:"Draft",value:"draft"},{name:"Archived",value:"archived"}],getBudgetImported:a=>a.budget_imported},actions:{async fetchAllBudget(a){await V.fetchAll(a).then(o=>this.response_budget=o)},async fetchBudgetDetail(a){await V.getBudgetDetail(a).then(o=>this.current_budget=o)},async updateBudget(a){await V.updateBudget(a).then(o=>this.current_budget=o)},async deleteBudget(a){await V.deleteBudget(a).then(o=>this.current_budget=o)},async importBudget(a){await V.importBudget(a).then(o=>this.budget_imported=o)}}}),be={setup(){const a=se("dialogRef"),o=["January","February","March","April","May","June","July","August","September","October","November","December"];I(()=>{r.value=a.value.data.budget,e.value=a.value.data.year});const r=f(),e=f();return{budgetDetail:r,year:e,monthNamesShort:o,formatValue:function(x,d){let l=x-d;return M(l).replace(/\,00$/,"")},formatNumber:M}}},ye={key:0,class:"border-round-lg p-4 bg-green-500 mb-3 text-center text-white"},he={class:"text-xl"},ve={key:1,class:"flex justify-content-between flex-column row-gap-2 border-round-lg p-3 surface-100"},we={class:"flex-1"},Be={class:"flex-1 flex justify-content-end"},xe={key:0},De={key:1};function Ce(a,o,r,e,B,x){return i(),u("div",null,[e.budgetDetail&&e.budgetDetail.amount&&e.budgetDetail.remaining?(i(),u("div",ye,[y("span",he,[y("b",null,h(e.formatValue(e.budgetDetail.amount,e.budgetDetail.remaining)+""),1),F("/"+h(e.formatNumber(e.budgetDetail.amount)+"")+" €",1)])])):z("",!0),e.budgetDetail?(i(),u("div",ve,[(i(!0),u(le,null,re(e.budgetDetail.spent,(d,l)=>(i(),u("div",{key:d.id,class:"flex pb-3 pt-2",style:{"border-bottom":"1px solid #e9ecef"}},[y("div",we,h(e.monthNamesShort[l])+" "+h(e.year),1),y("div",Be,[d=="0.0"?(i(),u("b",xe,"0€")):(i(),u("b",De,h(e.formatNumber(d)+"")+"€",1))])]))),128))])):z("",!0)])}const ke=N(be,[["render",Ce]]),Se={props:["year"],setup(a){I(()=>{_.value=!0,t.value={first:0,rows:k.value.rows,sortField:null,sortOrder:null,filters:w.value},ee.register("myfilter",(n,m)=>n===m)});const o=P(),r=me(),e=K(),B=ge(),x=_e(),d=T(()=>o.responseBudget),l=T(()=>r.allCountries),g=T(()=>e.getSelectedCountry),v=L(),k=f(),w=f({"user.sellout_code":{value:"",matchMode:"contains"},"user.company_name":{value:"",matchMode:"contains"}}),_=f(!0),t=f(),c=f(0),D=f([]);function S(){_.value=!0;const n=new Map;n.set("country_id",g.value.id),n.set("year",a.year),n.set("page",1),n.set("per_page",t.value.rows),setTimeout(()=>{Y(n)},Math.random()*1e3+250)}const Y=async function(n){await o.fetchAllBudget(n).then(()=>{_.value=!1}).catch(m=>{_.value=!1,U(v,m)})},J=n=>{t.value=n,S()},q=()=>{t.value.page=0,t.value.filters=w.value,S()},$=function(n){ie.push({name:"budget-detail",params:{id:n.id}})},G=(n,m)=>{B.require({target:n.currentTarget,message:"Are you sure you want to remove this budget?",icon:"pi pi-exclamation-triangle",accept:()=>{H(m.id)}})},H=async function(n){await o.deleteBudget(n).then(()=>{R(v,{message:"Budget deleted correctly.",title:""}),S()}).catch(m=>{U(v,m)})},Q=n=>{x.open(ke,{props:{header:"Budget Detail",style:{width:"20vw"},breakpoints:{"1450px":"25vw","1200px":"30vw","960px":"50vw","640px":"90vw"},modal:!0},data:{budget:n,year:a.year},onClose:m=>{}})},W=n=>{X(n)},X=async function(n){const m={id:n.id,budget_data:n};O(),o.updateBudget(m).then(()=>{var C;A(),S(),R(v,{message:"Budget updated correctly.",title:""}),(C=document.getElementById("closeRow"))==null||C.click()}).catch(C=>{A(),U(v,C)})},Z=function(n,m){var C=0;if(n)return C=n-m,C==0?C:M(+C)};return de(()=>a.year,(n,m)=>{S()}),{dt:k,responseBudget:d,filters:w,loading:_,totalRecords:c,lazyParams:t,countries:l,editingRows:D,onPage:J,onFilter:q,toggleEdit:$,loadLazyData:S,confirmDeleteBudget:G,showDetail:Q,onRowEditSave:W,formatNumber:M,calcSpent:Z}}};const Te={key:0},Ve={key:1},Fe={key:0},Ue={key:1},Me={key:0},Re={key:1};function Ae(a,o,r,e,B,x){const d=b("InputText"),l=b("Column"),g=b("Button"),v=b("DataTable"),k=b("ConfirmPopup"),w=b("DynamicDialog"),_=ue("tooltip");return i(),u("div",null,[s(v,{value:e.responseBudget.budget_data,totalRecords:e.responseBudget.total,lazy:!1,paginator:!1,rows:100,filters:e.filters,"onUpdate:filters":o[0]||(o[0]=t=>e.filters=t),ref:"dt",dataKey:"id",loading:e.loading,onPage:o[1]||(o[1]=t=>e.onPage(t)),filterDisplay:"row",removableSort:"",editingRows:e.editingRows,"onUpdate:editingRows":o[2]||(o[2]=t=>e.editingRows=t),tableClass:"editable-cells-table",editMode:"row"},{empty:p(()=>[F(" No budgets found. ")]),default:p(()=>[s(l,{filterField:"user.sellout_code",header:"Sellout code",filterMatchMode:"contains",sortable:"",showFilterMatchModes:!1,showFilterOperator:!1,showFilterMenu:!1},{body:p(({data:t})=>[F(h(t.user.sellout_code),1)]),filter:p(({filterModel:t,filterCallback:c})=>[s(d,{type:"text",modelValue:t.value,"onUpdate:modelValue":D=>t.value=D,onKeydown:E(D=>c(),["enter"]),class:"p-column-filter",placeholder:"Filter by sellout code"},null,8,["modelValue","onUpdate:modelValue","onKeydown"])]),_:1}),s(l,{filterField:"user.company_name",header:"Company",filterMatchMode:"contains",ref:"company_name",sortable:!1,showFilterMatchModes:!1,showFilterOperator:!1,showFilterMenu:!1},{filter:p(({filterModel:t,filterCallback:c})=>[s(d,{type:"text",modelValue:t.value,"onUpdate:modelValue":D=>t.value=D,onKeydown:E(D=>c(),["enter"]),class:"p-column-filter",placeholder:"Filter by company"},null,8,["modelValue","onUpdate:modelValue","onKeydown"])]),body:p(({data:t})=>[F(h(t.user.company_name),1)]),_:1},512),s(l,{field:"spent",header:"Spent",sortable:""},{body:p(({data:t})=>[t.spent?(i(),u("span",Te,h(e.calcSpent(t.amount,t.remaining)+"")+" €",1)):(i(),u("span",Ve,"-"))]),_:1}),s(l,{field:"remaining",header:"Remaining",sortable:""},{body:p(({data:t})=>[t.remaining?(i(),u("span",Fe,h(e.formatNumber(t.remaining)+"")+" €",1)):(i(),u("span",Ue,"-"))]),_:1}),s(l,{field:"amount",header:"Total",sortable:""},{body:p(({data:t})=>[t.amount?(i(),u("span",Me,h(e.formatNumber(t.amount)+"")+" €",1)):(i(),u("span",Re,"-"))]),editor:p(({data:t,field:c})=>[s(d,{modelValue:t[c],"onUpdate:modelValue":D=>t[c]=D},null,8,["modelValue","onUpdate:modelValue"])]),_:1}),s(l,{rowEditor:!0,style:{width:"13rem"},bodyStyle:"text-align:center"},{body:p(t=>[ce(s(g,{type:"button",onClick:c=>e.showDetail(t.data),"aria-haspopup":"true","aria-controls":"overlay_menu",class:"p-button-text p-button-rounded text-300 surface-200 mr-3",icon:"pi pi-eye"},null,8,["onClick"]),[[_,"Show detail",void 0,{top:!0}]]),s(g,{icon:"pi pi-pencil",class:"p-button-text p-button-rounded text-300 surface-200 mr-3",onClick:t.editorInitCallback},null,8,["onClick"]),s(g,{icon:"pi pi-trash",class:"p-button-text p-button-rounded text-300 surface-200 mr-3",onClick:c=>e.confirmDeleteBudget(c,t.data)},null,8,["onClick"])]),editor:p(t=>[s(g,{icon:"pi pi-check",class:"p-button-rounded p-button-primary mr-3",onClick:c=>e.onRowEditSave(t.data)},null,8,["onClick"]),s(g,{icon:"pi pi-times",class:"p-button-rounded p-button-secondary",onClick:t.editorCancelCallback,id:"closeRow"},null,8,["onClick"])]),_:1})]),_:1},8,["value","totalRecords","filters","loading","editingRows"]),s(k),s(w)])}const Ne=N(Se,[["render",Ae]]),je={setup(){const a=P(),o=K(),r=L(),e=f(),B=f([]),x=f(),d=T(()=>a.getTotalBudget),l=T(()=>a.getBudgetImported),g=T(()=>o.getSelectedCountry);return pe(async()=>{e.value=fe.now().toFormat("yyyy"),B.value.push(e.value),B.value.push(+e.value+1)}),{totalBudget:d,selectedYear:e,years:B,budgetTable:x,onUpload:w=>{O();const _=new FormData;_.append("file",w.files[0]),_.append("year",e.value),_.append("country_id",g.value.id+"");const t={formData:_};a.importBudget(t).then(()=>{A(),x.value.loadLazyData(),l.value?R(r,{message:l.value+" targets imported successfully",title:""}):R(r,{message:"File imported successfully",title:""})}).catch(c=>{A(),U(r,c)})},downloadTemplate:function(){window.open("https://petronas-adv.s3-eu-west-1.amazonaws.com/template_bonus.xlsx","_blank")}}},components:{BudgetTable:Ne}},ze=y("div",{class:"flex justify-content-between align-items-center"},[y("h1",{class:"uppercase"},"Budget")],-1),Ee={class:"col-2"},Ie={class:"flex justify-content-between align-items-center"},Ke={class:"uppercase"},Le={class:"col-6 flex align-items-center justify-content-end"};function Oe(a,o,r,e,B,x){const d=b("Dropdown"),l=b("Card"),g=b("Button"),v=b("FileUpload"),k=b("BudgetTable");return i(),u("div",null,[s(l,null,{content:p(()=>[ze,y("div",Ee,[s(d,{modelValue:e.selectedYear,"onUpdate:modelValue":o[0]||(o[0]=w=>e.selectedYear=w),options:e.years,placeholder:"Select a year",class:"w-full md:w-14rem"},null,8,["modelValue","options"])])]),_:1}),s(l,{class:"mt-4"},{content:p(()=>[y("div",Ie,[y("h2",Ke,[y("span",null,h(e.totalBudget)+" Record",1)]),y("div",Le,[s(g,{label:"template",icon:"pi pi-download",class:"p-button-outlined mr-3",onClick:o[1]||(o[1]=w=>e.downloadTemplate())}),s(v,{mode:"basic",name:"demo[]",url:"./upload.php",accept:".csv, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel",maxFileSize:1e6,onUploader:e.onUpload,customUpload:"",auto:!0,chooseLabel:"Budget",class:"p-button-outlined"},null,8,["onUploader"])])]),s(k,{ref:"budgetTable",year:e.selectedYear},null,8,["year"])]),_:1})])}const We=N(je,[["render",Oe]]);export{We as default};
