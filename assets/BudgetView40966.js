import{a as X}from"./api.esm40966.js";import{aa as N,an as Z,ae as ee,ao as te,a9 as ae,a8 as oe,ab as E,r as _,_ as A,o as c,e as p,f,x as v,B as T,i as I,F as ne,A as se,u as K,c as F,ac as L,ag as le,a as re,b as h,k as de,g as s,v as u,w as ie,n as ue}from"./usetoast.esm40966.js";import{u as ce}from"./country40966.js";import{e as U,a as M,s as z,h as R}from"./helpers40966.js";import{u as pe}from"./useconfirm.esm40966.js";import{u as me}from"./usedialog.esm40966.js";import{w as j}from"./runtime-dom.esm-bundler40966.js";import{D as ge}from"./datetime40966.js";class S{static async fetchAll(t){return(await N("/budget_data",t)).data}static async getBudgetDetail(t){return(await N(`/budget_data/${t}`)).data.budget}static async deleteBudget(t){return(await Z(`/budget_data/${t}`)).data}static async updateBudget(t){return(await ee(`/budget_data/${t.id}`,t.budget_data)).data.budget_data}static async importBudget(t){return(await te("/budget_data/upload_budget",t.formData)).data.updated_targets}}const O=ae({id:"budget",state:()=>({current_budget:{},budget:[],response_budget:{},total_budget:Number,budget_imported:""}),getters:{allBudget:o=>o.response_budget.budget_data,responseBudget:o=>o.response_budget,getTotalBudget:o=>o.response_budget?o.response_budget.total:0,getCurrentBudget:o=>o.current_budget,budgetStatus:()=>[{name:"Online",value:"online"},{name:"Draft",value:"draft"},{name:"Archived",value:"archived"}],getBudgetImported:o=>o.budget_imported},actions:{async fetchAllBudget(o){await S.fetchAll(o).then(t=>this.response_budget=t)},async fetchBudgetDetail(o){await S.getBudgetDetail(o).then(t=>this.current_budget=t)},async updateBudget(o){await S.updateBudget(o).then(t=>this.current_budget=t)},async deleteBudget(o){await S.deleteBudget(o).then(t=>this.current_budget=t)},async importBudget(o){await S.importBudget(o).then(t=>this.budget_imported=t)}}}),_e={setup(){const o=oe("dialogRef"),t=["January","February","March","April","May","June","July","August","September","October","November","December"];E(()=>{r.value=o.value.data.budget,e.value=o.value.data.year});const r=_(),e=_();return{budgetDetail:r,year:e,monthNamesShort:t,formatValue:function(B,d){let l=B-d,i=parseFloat(l+"").toFixed(2);return i=="0.00"?"0":i}}}},fe={key:0,class:"border-round-lg p-4 bg-green-500 mb-3 text-center text-white"},ye={class:"text-xl"},be={key:1,class:"flex justify-content-between flex-column row-gap-2 border-round-lg p-3 surface-100"},he={class:"flex-1"},ve={class:"flex-1 flex justify-content-end"},we={key:0},Be={key:1};function xe(o,t,r,e,w,B){return c(),p("div",null,[e.budgetDetail&&e.budgetDetail.amount&&e.budgetDetail.remaining?(c(),p("div",fe,[f("span",ye,[f("b",null,v(e.formatValue(e.budgetDetail.amount,e.budgetDetail.remaining)),1),T("/"+v(e.budgetDetail.amount)+"€",1)])])):I("",!0),e.budgetDetail?(c(),p("div",be,[(c(!0),p(ne,null,se(e.budgetDetail.spent,(d,l)=>(c(),p("div",{key:d.id,class:"flex pb-3 pt-2",style:{"border-bottom":"1px solid #e9ecef"}},[f("div",he,v(e.monthNamesShort[l])+" "+v(e.year),1),f("div",ve,[d=="0.0"?(c(),p("b",we,"0€")):(c(),p("b",Be,v(parseFloat(d+"").toFixed(2))+"€",1))])]))),128))])):I("",!0)])}const De=A(_e,[["render",xe]]),Ce={props:["year"],setup(o){E(()=>{x.value=!0,a.value={first:0,rows:C.value.rows,sortField:null,sortOrder:null,filters:b.value},X.register("myfilter",(n,g)=>n===g)});const t=O(),r=ce(),e=K(),w=pe(),B=me(),d=F(()=>t.responseBudget),l=F(()=>r.allCountries),i=F(()=>e.getSelectedCountry),y=L(),C=_(),b=_({"user.sellout_code":{value:"",matchMode:"contains"},"user.company_name":{value:"",matchMode:"contains"}}),x=_(!0),a=_(),m=_(0),D=_([]);function k(){x.value=!0;const n=new Map;n.set("country_id",i.value.id),n.set("year",o.year),n.set("page",1),n.set("per_page",a.value.rows),setTimeout(()=>{P(n)},Math.random()*1e3+250)}const P=async function(n){await t.fetchAllBudget(n).then(()=>{x.value=!1}).catch(g=>{x.value=!1,U(y,g)})},Y=n=>{a.value=n,k()},$=()=>{a.value.page=0,a.value.filters=b.value,k()},J=function(n){re.push({name:"budget-detail",params:{id:n.id}})},q=(n,g)=>{w.require({target:n.currentTarget,message:"Are you sure you want to remove this budget?",icon:"pi pi-exclamation-triangle",accept:()=>{G(g.id)}})},G=async function(n){await t.deleteBudget(n).then(()=>{M(y,{message:"Budget deleted correctly.",title:""}),k()}).catch(g=>{U(y,g)})},H=n=>{B.open(De,{props:{header:"Budget Detail",style:{width:"20vw"},breakpoints:{"1450px":"25vw","1200px":"30vw","960px":"50vw","640px":"90vw"},modal:!0},data:{budget:n,year:o.year},onClose:g=>{}})},Q=n=>{W(n)},W=async function(n){const g={id:n.id,budget_data:n};z(),t.updateBudget(g).then(()=>{var V;R(),k(),M(y,{message:"Budget updated correctly.",title:""}),(V=document.getElementById("closeRow"))==null||V.click()}).catch(V=>{R(),U(y,V)})};return le(()=>o.year,(n,g)=>{k()}),{dt:C,responseBudget:d,filters:b,loading:x,totalRecords:m,lazyParams:a,countries:l,editingRows:D,onPage:Y,onFilter:$,toggleEdit:J,loadLazyData:k,confirmDeleteBudget:q,showDetail:H,onRowEditSave:Q}}};const ke={key:0},Fe={key:1},Se={key:0},Ve={key:1};function Te(o,t,r,e,w,B){const d=h("InputText"),l=h("Column"),i=h("Button"),y=h("DataTable"),C=h("ConfirmPopup"),b=h("DynamicDialog"),x=de("tooltip");return c(),p("div",null,[s(y,{value:e.responseBudget.budget_data,totalRecords:e.responseBudget.total,lazy:!1,paginator:!1,rows:100,filters:e.filters,"onUpdate:filters":t[0]||(t[0]=a=>e.filters=a),ref:"dt",dataKey:"id",loading:e.loading,onPage:t[1]||(t[1]=a=>e.onPage(a)),filterDisplay:"row",removableSort:"",editingRows:e.editingRows,"onUpdate:editingRows":t[2]||(t[2]=a=>e.editingRows=a),tableClass:"editable-cells-table",editMode:"row"},{empty:u(()=>[T(" No budgets found. ")]),default:u(()=>[s(l,{filterField:"user.sellout_code",header:"Sellout code",filterMatchMode:"contains",sortable:"",showFilterMatchModes:!1,showFilterOperator:!1,showFilterMenu:!1},{body:u(({data:a})=>[T(v(a.user.sellout_code),1)]),filter:u(({filterModel:a,filterCallback:m})=>[s(d,{type:"text",modelValue:a.value,"onUpdate:modelValue":D=>a.value=D,onKeydown:j(D=>m(),["enter"]),class:"p-column-filter",placeholder:"Filter by sellout code"},null,8,["modelValue","onUpdate:modelValue","onKeydown"])]),_:1}),s(l,{filterField:"user.company_name",header:"Company",filterMatchMode:"contains",ref:"company_name",sortable:!1,showFilterMatchModes:!1,showFilterOperator:!1,showFilterMenu:!1},{filter:u(({filterModel:a,filterCallback:m})=>[s(d,{type:"text",modelValue:a.value,"onUpdate:modelValue":D=>a.value=D,onKeydown:j(D=>m(),["enter"]),class:"p-column-filter",placeholder:"Filter by company"},null,8,["modelValue","onUpdate:modelValue","onKeydown"])]),body:u(({data:a})=>[T(v(a.user.company_name),1)]),_:1},512),s(l,{field:"remaining",header:"Remaining",sortable:""},{body:u(({data:a})=>[a.remaining?(c(),p("span",ke,v(a.remaining)+"€",1)):(c(),p("span",Fe,"-"))]),_:1}),s(l,{field:"amount",header:"Total",sortable:""},{body:u(({data:a})=>[a.amount?(c(),p("span",Se,v(a.amount)+"€",1)):(c(),p("span",Ve,"-"))]),editor:u(({data:a,field:m})=>[s(d,{modelValue:a[m],"onUpdate:modelValue":D=>a[m]=D},null,8,["modelValue","onUpdate:modelValue"])]),_:1}),s(l,{rowEditor:!0,style:{width:"13rem"},bodyStyle:"text-align:center"},{body:u(a=>[ie(s(i,{type:"button",onClick:m=>e.showDetail(a.data),"aria-haspopup":"true","aria-controls":"overlay_menu",class:"p-button-text p-button-rounded text-300 surface-200 mr-3",icon:"pi pi-eye"},null,8,["onClick"]),[[x,"Show detail",void 0,{top:!0}]]),s(i,{icon:"pi pi-pencil",class:"p-button-text p-button-rounded text-300 surface-200 mr-3",onClick:a.editorInitCallback},null,8,["onClick"]),s(i,{icon:"pi pi-trash",class:"p-button-text p-button-rounded text-300 surface-200 mr-3",onClick:m=>e.confirmDeleteBudget(m,a.data)},null,8,["onClick"])]),editor:u(a=>[s(i,{icon:"pi pi-check",class:"p-button-rounded p-button-primary mr-3",onClick:m=>e.onRowEditSave(a.data)},null,8,["onClick"]),s(i,{icon:"pi pi-times",class:"p-button-rounded p-button-secondary",onClick:a.editorCancelCallback,id:"closeRow"},null,8,["onClick"])]),_:1})]),_:1},8,["value","totalRecords","filters","loading","editingRows"]),s(C),s(b)])}const Ue=A(Ce,[["render",Te]]),Me={setup(){const o=O(),t=K(),r=L(),e=_(),w=_([]),B=_(),d=F(()=>o.getTotalBudget),l=F(()=>o.getBudgetImported),i=F(()=>t.getSelectedCountry);return ue(async()=>{e.value=ge.now().toFormat("yyyy"),w.value.push(e.value),w.value.push(+e.value+1)}),{totalBudget:d,selectedYear:e,years:w,budgetTable:B,onUpload:C=>{z();const b=new FormData;b.append("file",C.files[0]),b.append("year",e.value),b.append("country_id",i.value.id+"");const x={formData:b};o.importBudget(x).then(()=>{R(),B.value.loadLazyData(),l.value?M(r,{message:l.value+" targets imported successfully",title:""}):M(r,{message:"File imported successfully",title:""})}).catch(a=>{R(),U(r,a)})}}},components:{BudgetTable:Ue}},Re=f("div",{class:"flex justify-content-between align-items-center"},[f("h1",{class:"uppercase"},"Budget")],-1),Ae={class:"col-2"},Ne={class:"flex justify-content-between align-items-center"},Ie={class:"uppercase"},je={class:"col-6 flex align-items-center justify-content-end"};function Ee(o,t,r,e,w,B){const d=h("Dropdown"),l=h("Card"),i=h("FileUpload"),y=h("BudgetTable");return c(),p("div",null,[s(l,null,{content:u(()=>[Re,f("div",Ae,[s(d,{modelValue:e.selectedYear,"onUpdate:modelValue":t[0]||(t[0]=C=>e.selectedYear=C),options:e.years,placeholder:"Select a year",class:"w-full md:w-14rem"},null,8,["modelValue","options"])])]),_:1}),s(l,{class:"mt-4"},{content:u(()=>[f("div",Ne,[f("h2",Ie,[f("span",null,v(e.totalBudget)+" Record",1)]),f("div",je,[s(i,{mode:"basic",name:"demo[]",url:"./upload.php",accept:".csv, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel",maxFileSize:1e6,onUploader:e.onUpload,customUpload:"",auto:!0,chooseLabel:"Budget",class:"p-button-outlined"},null,8,["onUploader"])])]),s(y,{ref:"budgetTable",year:e.selectedYear},null,8,["year"])]),_:1})])}const qe=A(Me,[["render",Ee]]);export{qe as default};
